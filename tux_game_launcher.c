#include <stdio.h>      // printf, scanf ë“± ì…ì¶œë ¥ í•¨ìˆ˜
#include <stdlib.h>     // exit, system ë“± ì‹œìŠ¤í…œ í•¨ìˆ˜
#include <unistd.h>     // fork, execlp ë“± í”„ë¡œì„¸ìŠ¤ ê´€ë ¨ í•¨ìˆ˜
#include <sys/wait.h>   // waitpid ë“± í”„ë¡œì„¸ìŠ¤ ëŒ€ê¸° í•¨ìˆ˜

/**
 * ê²Œì„ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” êµ¬ì¡°ì²´
 */
typedef struct {
    int id;                  // ê²Œì„ ë²ˆí˜¸ (1, 2, 3, 4)
    char name[50];           // ê²Œì„ ì´ë¦„ (ì˜ˆ: "Neverball")
    char command[100];       // ì‹¤í–‰ ëª…ë ¹ì–´ (ì˜ˆ: "neverball")
    char description[100];   // ê²Œì„ ì„¤ëª…
} Game;

/**
 * ê²Œì„ ì‹¤í–‰ í•¨ìˆ˜
 * @param command ì‹¤í–‰í•  ê²Œì„ ëª…ë ¹ì–´ (ì˜ˆ: "neverball")
 * @return ì„±ê³µì‹œ 0, ì‹¤íŒ¨ì‹œ -1
 */
int run_game(const char* command) {
    printf("\nê²Œì„ì„ ì‹¤í–‰í•©ë‹ˆë‹¤: %s\n", command);
    printf("ê²Œì„ ì¢…ë£Œ í›„ ìŠ¤ì½”ì–´ê°€ íŒŒì‹±ë©ë‹ˆë‹¤.\n\n");
    
    // fork(): í˜„ì¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ë³µì œí•´ì„œ ìì‹ í”„ë¡œì„¸ìŠ¤ ìƒì„±
    // ë¶€ëª¨ëŠ” ìì‹ì˜ PIDë¥¼ ë°›ê³ , ìì‹ì€ 0ì„ ë°›ìŒ
    pid_t pid = fork();
    
    if (pid < 0) {
        // fork ì‹¤íŒ¨ (ë©”ëª¨ë¦¬ ë¶€ì¡± ë“±)
        fprintf(stderr, "í”„ë¡œì„¸ìŠ¤ ìƒì„± ì‹¤íŒ¨\n");
        return -1;
    }
    else if (pid == 0) {
        // ìì‹ í”„ë¡œì„¸ìŠ¤ ì˜ì—­ (pid == 0)
        // execlp(): í˜„ì¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ìƒˆ í”„ë¡œê·¸ë¨ìœ¼ë¡œ êµì²´
        // execlp(íŒŒì¼ëª…, argv[0], argv[1], ..., NULL)
        execlp(command, command, NULL);
        
        // ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ execlp ì‹¤íŒ¨ (ê²Œì„ ì‹¤í–‰ ì•ˆ ë¨)
        fprintf(stderr, "ê²Œì„ ì‹¤í–‰ ì‹¤íŒ¨: %s\n", command);
        exit(1);  // ìì‹ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
    }
    else {
        // ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ ì˜ì—­ (pid > 0)
        int status;
        
        // waitpid(): ìì‹ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        // ì¦‰, ê²Œì„ì´ ëë‚  ë•Œê¹Œì§€ ì—¬ê¸°ì„œ ë©ˆì¶°ìˆìŒ
        waitpid(pid, &status, 0);
        
        // WIFEXITED(): ìì‹ì´ ì •ìƒ ì¢…ë£Œí–ˆëŠ”ì§€ í™•ì¸
        if (WIFEXITED(status)) {
            printf("\nê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n");
            return 0;
        }
        else {
            fprintf(stderr, "ê²Œì„ì´ ë¹„ì •ìƒ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n");
            return -1;
        }
    }
}

/**
 * ê²Œì„ ì„ íƒ ë©”ë‰´ ì¶œë ¥
 * @param games ê²Œì„ ë°°ì—´
 * @param game_count ê²Œì„ ê°œìˆ˜
 */
void show_game_menu(Game* games, int game_count) {
    // ë©”ë‰´ í—¤ë” ì¶œë ¥
    printf("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘         Tux ê²Œì„ ë¡œê¹… ì‹œìŠ¤í…œ (C)              â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
    
    printf("í”Œë ˆì´í•  ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”:\n\n");
    
    // ëª¨ë“  ê²Œì„ì„ ë°˜ë³µí•˜ë©´ì„œ ì¶œë ¥
    for (int i = 0; i < game_count; i++) {
        printf("  [%d] %s\n", games[i].id, games[i].name);
        printf("      %s\n\n", games[i].description);
    }
    
    printf("  [0] ì¢…ë£Œ\n\n");
    printf("ì„ íƒ: ");
}

/**
 * ê²Œì„ë³„ ë¡œê·¸ íŒŒì‹± í•¨ìˆ˜ (ì¶”í›„ êµ¬í˜„)
 * @param game_id ê²Œì„ ë²ˆí˜¸
 */
void parse_game_logs(int game_id) {
    printf("\n=== ë¡œê·¸ íŒŒì‹± ì¤‘... ===\n");
    
    // switch-case: game_id ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ë™ì‘
    switch(game_id) {
        case 1:
            printf("Neverball ë¡œê·¸ íŒŒì‹± (ì¶”í›„ êµ¬í˜„)\n");
            // TODO: Neverball ë¡œê·¸ íŒŒì‹± ì½”ë“œ ì‘ì„± ì˜ˆì •
            break;
        case 2:
            printf("SuperTux ë¡œê·¸ íŒŒì‹± (ì¶”í›„ êµ¬í˜„)\n");
            // TODO: SuperTux ë¡œê·¸ íŒŒì‹± ì½”ë“œ ì‘ì„± ì˜ˆì •
            break;
        case 3:
            printf("Extreme Tux Racer ë¡œê·¸ íŒŒì‹± (ì¶”í›„ êµ¬í˜„)\n");
            // TODO: ETR ë¡œê·¸ íŒŒì‹± ì½”ë“œ ì‘ì„± ì˜ˆì •
            break;
        case 4:
            printf("Frozen Bubble ë¡œê·¸ íŒŒì‹± (ì¶”í›„ êµ¬í˜„)\n");
            // TODO: Frozen Bubble ë¡œê·¸ íŒŒì‹± ì½”ë“œ ì‘ì„± ì˜ˆì •
            break;
        default:
            printf("ì•Œ ìˆ˜ ì—†ëŠ” ê²Œì„\n");
    }
    
    printf("\n");
}

/**
 * ë©”ì¸ í•¨ìˆ˜: í”„ë¡œê·¸ë¨ ì‹œì‘ì 
 */
int main() {
    // ê²Œì„ ë°°ì—´ ì´ˆê¸°í™”
    // {ê²Œì„ë²ˆí˜¸, "ê²Œì„ì´ë¦„", "ì‹¤í–‰ëª…ë ¹ì–´", "ì„¤ëª…"}
    Game games[] = {
        {1, "Neverball", "neverball", "ğŸ± ê³µ êµ´ë¦¬ê¸° í¼ì¦ ê²Œì„"},
        {2, "SuperTux", "supertux2", "ğŸ§ ìŠˆí¼ë§ˆë¦¬ì˜¤ ìŠ¤íƒ€ì¼ í”Œë«í¬ë¨¸"},
        {3, "Extreme Tux Racer", "etr", "â›·ï¸  í­ê·„ ìŠ¤í‚¤ ë ˆì´ì‹±"},
        {4, "Frozen Bubble", "frozen-bubble", "ğŸ«§ ë²„ë¸” ìŠˆí„° í¼ì¦"}
    };
    
    // sizeof(games): ì „ì²´ ë°°ì—´ í¬ê¸° (ë°”ì´íŠ¸)
    // sizeof(Game): êµ¬ì¡°ì²´ í•˜ë‚˜ í¬ê¸° (ë°”ì´íŠ¸)
    // ë‚˜ëˆ„ë©´ ê²Œì„ ê°œìˆ˜ê°€ ë‚˜ì˜´ (4ê°œ)
    int game_count = sizeof(games) / sizeof(Game);
    
    // ì‹œì‘ ë©”ì‹œì§€
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘              Tux Gaming System                 â•‘\n");
    printf("â•‘          ê²Œì„íŒ¨ë“œ ë¡œê¹… í”„ë¡œì íŠ¸                â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    // ë¬´í•œ ë£¨í”„: ì‚¬ìš©ìê°€ 0ì„ ì…ë ¥í•  ë•Œê¹Œì§€ ë°˜ë³µ
    while (1) {
        // 1. ê²Œì„ ë©”ë‰´ í‘œì‹œ
        show_game_menu(games, game_count);
        
        // 2. ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
        int choice;
        // scanf: ì •ìˆ˜ ì…ë ¥ë°›ê¸°, ì„±ê³µí•˜ë©´ 1 ë°˜í™˜
        if (scanf("%d", &choice) != 1) {
            printf("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤.\n");
            // ì…ë ¥ ë²„í¼ ë¹„ìš°ê¸° (ì—”í„°í‚¤ ë“± ë‚¨ì€ ë¬¸ì ì œê±°)
            while (getchar() != '\n');
            continue;  // ë‹¤ì‹œ ë©”ë‰´ë¡œ
        }
        
        // 3. ì¢…ë£Œ í™•ì¸ (0 ì…ë ¥ì‹œ)
        if (choice == 0) {
            printf("\ní”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.\n");
            printf("ì¦ê±°ìš´ ê²Œì„ì´ì—ˆìŠµë‹ˆë‹¤! ğŸ§\n\n");
            break;  // while ë£¨í”„ íƒˆì¶œ -> í”„ë¡œê·¸ë¨ ì¢…ë£Œ
        }
        
        // 4. ì„ íƒí•œ ê²Œì„ ì°¾ê¸°
        int game_index = -1;  // -1ì€ "ëª» ì°¾ìŒ"ì„ ì˜ë¯¸
        for (int i = 0; i < game_count; i++) {
            if (games[i].id == choice) {
                game_index = i;  // ì°¾ì•˜ìœ¼ë©´ ì¸ë±ìŠ¤ ì €ì¥
                break;
            }
        }
        
        // 5. ì˜ëª»ëœ ì„ íƒ ì²˜ë¦¬
        if (game_index == -1) {
            printf("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. 1~%d ì¤‘ì—ì„œ ì„ íƒí•˜ì„¸ìš”.\n", game_count);
            continue;  // ë‹¤ì‹œ ë©”ë‰´ë¡œ
        }
        
        // 6. ê²Œì„ ì‹¤í–‰
        // games[game_index].command: ì„ íƒí•œ ê²Œì„ì˜ ì‹¤í–‰ ëª…ë ¹ì–´
        if (run_game(games[game_index].command) == 0) {
            // ê²Œì„ì´ ì •ìƒ ì¢…ë£Œë¨
            // 7. ë¡œê·¸ íŒŒì‹± (ì•„ì§ êµ¬í˜„ ì•ˆ ë¨)
            parse_game_logs(games[game_index].id);
        }
        
        // 8. ê³„ì†í•˜ë ¤ë©´ Enter ëŒ€ê¸°
        printf("\nê³„ì†í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...");
        getchar(); // scanf í›„ ë‚¨ì€ ê°œí–‰ ë¬¸ì ì œê±°
        getchar(); // ì‹¤ì œ Enter ì…ë ¥ ëŒ€ê¸°
    }
    
    return 0;  // í”„ë¡œê·¸ë¨ ì •ìƒ ì¢…ë£Œ
}